
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
    <title>cmiputil.drs &#8212; cmiputil  documentation</title>
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">cmiputil  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cmiputil.drs</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># coding:utf-8</span>

<span class="sd">&quot;&quot;&quot;CMIP6 Data Reference Syntax (DRS).</span>

<span class="sd">(Excerpt from http://goo.gl/v1drZl)</span>

<span class="sd">File name template:</span>
<span class="sd">-------------------</span>

<span class="sd">DRS compilent filename consists of several global attributes as</span>
<span class="sd">follows::</span>

<span class="sd">    filename = &lt;variable_id&gt;</span>
<span class="sd">                _&lt;table_id&gt;</span>
<span class="sd">                  _&lt;source_id&gt;</span>
<span class="sd">                    _&lt;experiment_id &gt;</span>
<span class="sd">                      _&lt;member_id&gt;</span>
<span class="sd">                        _&lt;grid_label&gt;</span>
<span class="sd">                          [_&lt;time_range&gt;].nc</span>

<span class="sd">For time-invariant fields, the last segment (&lt;time_range&gt;) above is</span>
<span class="sd">omitted.</span>

<span class="sd">All strings appearing in the file name are constructed using only the</span>
<span class="sd">following characters: a-z, A-Z, 0-9, and the hyphen (&quot;-&quot;), except the</span>
<span class="sd">hyphen must not appear in &lt;variable_id&gt;.  Underscores are prohibited</span>
<span class="sd">throughout except as shown in the template.</span>

<span class="sd">The &lt;member_id&gt; is constructed from the &lt;sub_experiment_id&gt; and</span>
<span class="sd">&lt;variant_label&gt; using the following algorithm:</span>

<span class="sd">|    if &lt;sub_experiment_id&gt; == “none”</span>
<span class="sd">|        &lt;member_id&gt; = &lt;variant_label&gt;</span>
<span class="sd">|    else</span>
<span class="sd">|        &lt;member_id&gt; = &lt;sub_experiment_id&gt;-&lt;variant_label&gt;</span>
<span class="sd">|    endif</span>

<span class="sd">The &lt;time_range&gt; is a string generated consistent with the following:</span>

<span class="sd">|    if frequency == “fx” then</span>
<span class="sd">|        &lt;time_range&gt;=””</span>
<span class="sd">|    else</span>
<span class="sd">|        &lt;time_range&gt; = N1-N2</span>
<span class="sd">|        where N1 and N2 are integers of the form</span>
<span class="sd">|        ‘yyyy[MM[dd[hh[mm[ss]]]]][&lt;suffix&gt;]’ (expressed as a string,where</span>
<span class="sd">|        where ‘yyyy’, ‘MM’, ‘dd’, ‘hh’ ‘mm’ and ‘ss’ are integer year,</span>
<span class="sd">|        month, day, hour, minute, and second, respectively)</span>
<span class="sd">|    endif</span>

<span class="sd">where &lt;suffix&gt; is defined as follows:</span>

<span class="sd">|    if the variable identified by variable_id has a time dimension with a “climatology” attribute then</span>
<span class="sd">|         &lt;suffix&gt; = “-clim”</span>
<span class="sd">|    else</span>
<span class="sd">|         &lt;suffix&gt; = “”</span>
<span class="sd">|    endif</span>

<span class="sd">and where the precision of the time_range strings is determined by the</span>
<span class="sd">&lt;frequency&gt; global attribute.</span>

<span class="sd">Example when there is no &lt;sub_experiment_id&gt;::</span>

<span class="sd">    tas_Amon_GFDL-CM4_historical_r1i1p1f1_gn_196001-199912.nc</span>

<span class="sd">Example with a &lt;sub_experiment_id&gt;::</span>

<span class="sd">    pr_day_CNRM-CM6-1_dcppA-hindcast_s1960-r2i1p1f1_gn_198001-198412.nc</span>



<span class="sd">Directory structure template:</span>
<span class="sd">-----------------------------</span>

<span class="sd">DRS complient directory structure consists of several global</span>
<span class="sd">attributes as follows::</span>

<span class="sd">    Directory structure = &lt;mip_era&gt;/</span>
<span class="sd">                            &lt;activity_id&gt;/</span>
<span class="sd">                              &lt;institution_id&gt;/</span>
<span class="sd">                                &lt;source_id&gt;/</span>
<span class="sd">                                  &lt;experiment_id&gt;/</span>
<span class="sd">                                    &lt;member_id&gt;/</span>
<span class="sd">                                      &lt;table_id&gt;/</span>
<span class="sd">                                        &lt;variable_id&gt;/</span>
<span class="sd">                                          &lt;grid_label&gt;/</span>
<span class="sd">                                            &lt;version&gt;</span>


<span class="sd">Note:</span>

<span class="sd">- &lt;version&gt; has the form “vYYYYMMDD” (e.g., “v20160314”), indicating a</span>
<span class="sd">  representative date for the version.  Note that files contained in a</span>
<span class="sd">  single &lt;version&gt; subdirectory at the end of the directory path</span>
<span class="sd">  should represent all the available time-samples reported from the</span>
<span class="sd">  simulation; a time-series can be split across several files, but all</span>
<span class="sd">  the files must be found in the same subdirectory.  This implies that</span>
<span class="sd">  &lt;version&gt; will not generally be the actual date that all files in</span>
<span class="sd">  the subdirectory were written or published.</span>
<span class="sd">- If multiple activities are listed in the global attribute, the first</span>
<span class="sd">  one is used in the directory structure.</span>


<span class="sd">Example when there is no &lt;sub-experiment_id&gt;::</span>

<span class="sd">     CMIP6/CMIP/NOAA-GFDL/GFDL-CM4/1pctCO2/r1i1p1f1/Amon/tas/gn/v20150322</span>

<span class="sd">Example with a &lt;sub_experiment_id&gt;::</span>

<span class="sd">     CMIP6/DCPP/CNRM-CERFACS/CNRM-CM6-1/dcppA-hindcast/s1960-r2i1p1f3/day/pr/gn/v20160215</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">cmiputil.convoc</span> <span class="k">import</span> <span class="n">ConVoc</span>
<span class="kn">import</span> <span class="nn">netCDF4</span> <span class="k">as</span> <span class="nn">nc</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">PurePath</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="k">import</span> <span class="n">pprint</span>


<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;T.Inoue&#39;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;0.9.0&#39;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s1">&#39;2019/04/16&#39;</span>


<div class="viewcode-block" id="DRSError"><a class="viewcode-back" href="../../cmiputil.html#cmiputil.drs.DRSError">[docs]</a><span class="k">class</span> <span class="nc">DRSError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base exception class for DRS.&quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="InvalidDRSAttribError"><a class="viewcode-back" href="../../cmiputil.html#cmiputil.drs.InvalidDRSAttribError">[docs]</a><span class="k">class</span> <span class="nc">InvalidDRSAttribError</span><span class="p">(</span><span class="n">DRSError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Error for invalid attribute as DRS.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="InvalidPathAsDRSError"><a class="viewcode-back" href="../../cmiputil.html#cmiputil.drs.InvalidPathAsDRSError">[docs]</a><span class="k">class</span> <span class="nc">InvalidPathAsDRSError</span><span class="p">(</span><span class="n">DRSError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Error for invalid path as DRS.&quot;&quot;&quot;</span></div>


<span class="n">sample_attrs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;activity_id&#39;</span><span class="p">:</span> <span class="s1">&#39;CMIP&#39;</span><span class="p">,</span>
    <span class="s1">&#39;experiment_id&#39;</span><span class="p">:</span> <span class="s1">&#39;piControl&#39;</span><span class="p">,</span>
    <span class="s1">&#39;grid_label&#39;</span><span class="p">:</span> <span class="s1">&#39;gn&#39;</span><span class="p">,</span>
    <span class="s1">&#39;institution_id&#39;</span><span class="p">:</span> <span class="s1">&#39;MIROC&#39;</span><span class="p">,</span>
    <span class="s1">&#39;source_id&#39;</span><span class="p">:</span> <span class="s1">&#39;MIROC6&#39;</span><span class="p">,</span>
    <span class="s1">&#39;table_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Amon&#39;</span><span class="p">,</span>
    <span class="s1">&#39;variable_id&#39;</span><span class="p">:</span> <span class="s1">&#39;tas&#39;</span><span class="p">,</span>
    <span class="s1">&#39;variant_label&#39;</span><span class="p">:</span> <span class="s1">&#39;r1i1p1f1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;v20190308&#39;</span><span class="p">,</span>
    <span class="s1">&#39;non_necessary_attribute&#39;</span><span class="p">:</span> <span class="s1">&#39;hoge&#39;</span>
<span class="p">}</span>
<span class="n">sample_fname</span> <span class="o">=</span> <span class="s2">&quot;tas_Amon_MIROC6_piControl_r1i1p1f1_gn.nc&quot;</span>
<span class="n">sample_dname</span> <span class="o">=</span> <span class="s2">&quot;CMIP6/CMIP/MIROC/MIROC6/piControl/&quot;</span>\
               <span class="s2">&quot;r1i1p1f1/Amon/tas/gn/v20190308&quot;</span>

<span class="n">sample_attrs_w_subexp</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;activity_id&#39;</span><span class="p">:</span> <span class="s1">&#39;DCPP&#39;</span><span class="p">,</span>
    <span class="s1">&#39;experiment_id&#39;</span><span class="p">:</span> <span class="s1">&#39;dcppC-atl-pacemaker&#39;</span><span class="p">,</span>
    <span class="s1">&#39;grid_label&#39;</span><span class="p">:</span> <span class="s1">&#39;gr&#39;</span><span class="p">,</span>
    <span class="s1">&#39;institution_id&#39;</span><span class="p">:</span> <span class="s1">&#39;IPSL&#39;</span><span class="p">,</span>
    <span class="s1">&#39;source_id&#39;</span><span class="p">:</span> <span class="s1">&#39;IPSL-CM6A-LR&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sub_experiment_id&#39;</span><span class="p">:</span> <span class="s1">&#39;s1950&#39;</span><span class="p">,</span>
    <span class="s1">&#39;table_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Amon&#39;</span><span class="p">,</span>
    <span class="s1">&#39;time_range&#39;</span><span class="p">:</span> <span class="s1">&#39;192001-201412&#39;</span><span class="p">,</span>
    <span class="s1">&#39;variable_id&#39;</span><span class="p">:</span> <span class="s1">&#39;rsdscs&#39;</span><span class="p">,</span>
    <span class="s1">&#39;variant_label&#39;</span><span class="p">:</span> <span class="s1">&#39;r1i1p1f1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;v20190110&#39;</span><span class="p">}</span>
<span class="n">sample_fname_w_subexp</span> <span class="o">=</span> <span class="s1">&#39;rsdscs_Amon_IPSL-CM6A-LR_dcppC-atl-pacemaker&#39;</span>\
                        <span class="s1">&#39;_s1950-r1i1p1f1_gr_192001-201412.nc&#39;</span>
<span class="n">sample_dname_w_subexp</span> <span class="o">=</span> <span class="s1">&#39;CMIP6/DCPP/IPSL/IPSL-CM6A-LR/dcppC-atl-pacemaker/&#39;</span>\
                        <span class="s1">&#39;s1950-r1i1p1f1/Amon/rsdscs/gr/v20190110&#39;</span>


<div class="viewcode-block" id="DRS"><a class="viewcode-back" href="../../cmiputil.html#cmiputil.drs.DRS">[docs]</a><span class="k">class</span> <span class="nc">DRS</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for CMIP6 DRS.</span>

<span class="sd">    This class contains attributes necessary to construct a file</span>
<span class="sd">    name/directory name that is valid for CMIP6 DRS (Data Reference</span>
<span class="sd">    Syntax).  See above and http://goo.gl/v1drZl for details about DRS</span>
<span class="sd">    as well as CMIP6 global attributes, etc.</span>

<span class="sd">    Instance member variables of this class are:</span>

<span class="sd">    - ``variable_id``</span>
<span class="sd">    - ``table_id``</span>
<span class="sd">    - ``source_id``</span>
<span class="sd">    - ``experiment_id``</span>
<span class="sd">    - ``grid_label``</span>
<span class="sd">    - ``time_range``</span>
<span class="sd">    - ``version``</span>
<span class="sd">    - ``sub_experiment_id``</span>
<span class="sd">    - ``variant_label``</span>
<span class="sd">    - ``member_id``</span>
<span class="sd">    - ``mip_era``</span>
<span class="sd">    - ``activity_id``</span>
<span class="sd">    - ``institution_id``</span>
<span class="sd">    - ``source_id``</span>

<span class="sd">    Note that ``member_id`` is not able to set directly, this is set by</span>
<span class="sd">    ``sub_experiment_id`` (omittable) and ``variant_label``.</span>

<span class="sd">    You can use the class member :attr:`requiredAttribs` to know</span>
<span class="sd">    necessary attributes to set a filename/dirname valid for DRS.</span>

<span class="sd">    Args:</span>
<span class="sd">        file(path-like): filename of valid CMIP6 netCDF file.</span>
<span class="sd">        filename(str): filename to be used to set attributes.</span>
<span class="sd">        kw(dict): attribute-value pairs</span>

<span class="sd">    If `file` is given, it must be a valid CMIP6 netCDF file, and</span>
<span class="sd">    attributes in that file are read and set.</span>

<span class="sd">    Else if `filename` is given, it must be a valid filename as DRS,</span>
<span class="sd">    and attributes are set from components consist of that filename.</span>

<span class="sd">    Else attributes are set from `**kw` dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">requiredAttribs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;activity_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;experiment_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;grid_label&#39;</span><span class="p">,</span>
        <span class="s1">&#39;institution_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mip_era&#39;</span><span class="p">,</span>
        <span class="s1">&#39;source_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sub_experiment_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;table_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;time_range&#39;</span><span class="p">,</span>
        <span class="s1">&#39;variable_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;variant_label&#39;</span><span class="p">,</span>
        <span class="s1">&#39;version&#39;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cvs</span> <span class="o">=</span> <span class="n">ConVoc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mip_era</span> <span class="o">=</span> <span class="s1">&#39;CMIP6&#39;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">drs</span><span class="o">.</span><span class="n">DRS</span><span class="o">.</span><span class="n">requiredAttribs</span><span class="p">}</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">=</span><span class="si">{!a}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
               <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">DRS</span><span class="o">.</span><span class="n">requiredAttribs</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;drs.DRS(&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{!a}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
               <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">DRS</span><span class="o">.</span><span class="n">requiredAttribs</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="DRS.getAttribs"><a class="viewcode-back" href="../../cmiputil.html#cmiputil.drs.DRS.getAttribs">[docs]</a>    <span class="k">def</span> <span class="nf">getAttribs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return current instance attributes defined of</span>
<span class="sd">        :attr:`requiredAttribs` and their values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: attribute-value pairs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">DRS</span><span class="o">.</span><span class="n">requiredAttribs</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)}</span></div>

    <span class="k">def</span> <span class="nf">_check_time_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># TODO: must be &#39;YYYYMMDD-YYYYMMDD&#39;, use regex.</span>
        <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_check_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># TODO: must be &#39;vYYYYMMDD&#39;, use regex.</span>
        <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_check_variable_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># TODO: Is there any method to check ?</span>
        <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_check_variant_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># TODO: must be r{i}i{i}p{i}f{i}, use regex.</span>
        <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<div class="viewcode-block" id="DRS.isValidValueForAttr"><a class="viewcode-back" href="../../cmiputil.html#cmiputil.drs.DRS.isValidValueForAttr">[docs]</a>    <span class="k">def</span> <span class="nf">isValidValueForAttr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check `value` is valid for the attribute `attr`.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (object) : value for `attr`</span>
<span class="sd">            attr (object) : global attribute</span>
<span class="sd">        Raises:</span>
<span class="sd">            InvalidDRSAttribError: raises when `attr` is invalid for DRS.</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: whether `value` is valid for the attribute `attr`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;sub_experiment_id&#39;</span><span class="p">:</span>
            <span class="c1"># TODO:</span>
            <span class="c1"># Currently, value of &lt;sub_experiment_id&gt; used in</span>
            <span class="c1"># published datasets is only &#39;s1920&#39;, which is not in CVs.</span>
            <span class="c1"># So avoid check tentatively</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">ConVoc</span><span class="p">()</span><span class="o">.</span><span class="n">isValidValueForAttr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;s1920&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">ConVoc</span><span class="p">()</span><span class="o">.</span><span class="n">managedAttribs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ConVoc</span><span class="p">()</span><span class="o">.</span><span class="n">isValidValueForAttr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;time_range&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_time_range</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;version&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_version</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;variable_id&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_variable_id</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;variant_label&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_variant_label</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;mip_era&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;cmip6&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidDRSAttribError</span><span class="p">(</span><span class="s1">&#39;Invalid Attribute for DRS:&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span></div>

<div class="viewcode-block" id="DRS.set"><a class="viewcode-back" href="../../cmiputil.html#cmiputil.drs.DRS.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_self</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">argv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set instance attributes, if attribute is in :attr:`requiredAttribs`.</span>

<span class="sd">        Missing attributes in `argv` are left unset/untouched.</span>
<span class="sd">        Attribute with invalid value is also unset/untouched sirently.</span>
<span class="sd">        Unnecessary attributes are neglected.</span>

<span class="sd">        Each of attributes are checked by</span>
<span class="sd">        :meth:`isValidValueForAttr()` before set.</span>

<span class="sd">        Args:</span>
<span class="sd">            argv (dict): attribute/value pairs</span>
<span class="sd">            return_self (bool): return self or nothing.</span>
<span class="sd">        Raises:</span>
<span class="sd">            InvalidDRSAttribError:  raises when `attr` is invalid for DRS.</span>
<span class="sd">        Return:</span>
<span class="sd">            nothing or self when `return_self` is ``True``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attribs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">DRS</span><span class="o">.</span><span class="n">requiredAttribs</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attribs</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isValidValueForAttr</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">a</span><span class="p">)):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;variant_label&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sub_experiment_id&#39;</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">member_id</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;sub_experiment_id&#39;</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;variant_label&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">member_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_label</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">return_self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DRS.fileName"><a class="viewcode-back" href="../../cmiputil.html#cmiputil.drs.DRS.fileName">[docs]</a>    <span class="k">def</span> <span class="nf">fileName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct filename from current instance member attributes.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AttributeError: any attributes are missing.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: filename</span>


<span class="sd">        Examples:</span>

<span class="sd">        DRS from dict w/o `time_range`</span>

<span class="sd">        &gt;&gt;&gt; drs.DRS(**drs.sample_attrs).fileName()</span>
<span class="sd">        &#39;tas_Amon_MIROC6_piControl_r1i1p1f1_gn.nc&#39;</span>

<span class="sd">        DRS from dict w/ `sub_experiment_id`</span>

<span class="sd">        &gt;&gt;&gt; drs.DRS(**drs.sample_attrs_w_subexp).fileName()</span>
<span class="sd">        &#39;rsdscs_Amon_IPSL-CM6A-LR_dcppC-atl-pacemaker_s1950-r1i1p1f1_gr_192001-201412.nc&#39;</span>

<span class="sd">        Invalid value for valid attrib</span>

<span class="sd">        &gt;&gt;&gt; attrs = {k: v for k, v in drs.sample_attrs.items()}</span>
<span class="sd">        &gt;&gt;&gt; attrs.update({&#39;table_id&#39;: &#39;invalid&#39;})</span>
<span class="sd">        &gt;&gt;&gt; d = drs.DRS(**attrs).fileName()</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">          ...</span>
<span class="sd">        AttributeError: &#39;DRS&#39; object has no attribute &#39;table_id&#39;</span>

<span class="sd">        In the example above, since the key ``table_id`` has invalid value,</span>
<span class="sd">        ``d.table_id`` is NOT set, and so the exception raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable_id</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">member_id</span>
        <span class="n">grd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_label</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;time_range&#39;</span><span class="p">)):</span>
            <span class="n">tim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_range</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{var}</span><span class="s2">_</span><span class="si">{tab}</span><span class="s2">_</span><span class="si">{src}</span><span class="s2">_</span><span class="si">{exp}</span><span class="s2">_</span><span class="si">{mem}</span><span class="s2">_</span><span class="si">{grd}</span><span class="s2">_</span><span class="si">{tim}</span><span class="s2">.nc&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{var}</span><span class="s2">_</span><span class="si">{tab}</span><span class="s2">_</span><span class="si">{src}</span><span class="s2">_</span><span class="si">{exp}</span><span class="s2">_</span><span class="si">{mem}</span><span class="s2">_</span><span class="si">{grd}</span><span class="s2">.nc&quot;</span>
        <span class="k">return</span> <span class="n">f</span></div>

<div class="viewcode-block" id="DRS.dirName"><a class="viewcode-back" href="../../cmiputil.html#cmiputil.drs.DRS.dirName">[docs]</a>    <span class="k">def</span> <span class="nf">dirName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct directory name by DRS from drs.DRS instance members.</span>

<span class="sd">        Args:</span>
<span class="sd">            prefix (Path-like): prepend to the result path.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AttributeError: any attributes are missing.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Path-like: directory name</span>

<span class="sd">        Examples:</span>

<span class="sd">        DRS from dict w/o ``time_range``.</span>

<span class="sd">        &gt;&gt;&gt; drs.DRS(**drs.sample_attrs).dirName()</span>
<span class="sd">        &#39;CMIP6/CMIP/MIROC/MIROC6/piControl/r1i1p1f1/Amon/tas/gn/v20190308&#39;</span>

<span class="sd">        DRS from dict w/ ``sub_experiment_id``.</span>

<span class="sd">        &gt;&gt;&gt; drs.DRS(**drs.sample_attrs_w_subexp).dirName() # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">        &#39;CMIP6/DCPP/IPSL/IPSL-CM6A-LR/dcppC-atl-pacemaker/s1950-r1i1p1f1/Amon/rsdscs/gr/v20190110&#39;</span>

<span class="sd">        Invalid value for valid attrib.</span>

<span class="sd">        &gt;&gt;&gt; attrs = {k:v for k,v in drs.sample_attrs.items()}</span>
<span class="sd">        &gt;&gt;&gt; attrs[&#39;table_id&#39;] = &#39;invalid&#39;</span>
<span class="sd">        &gt;&gt;&gt; drs.DRS(**attrs).dirName()</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">          ...</span>
<span class="sd">        AttributeError: &#39;DRS&#39; object has no attribute &#39;table_id&#39;</span>

<span class="sd">        In the example above, since ``table_id`` has invalid value, `d.table_id`</span>
<span class="sd">        has NOT set, and so the exception is raised.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">PurePath</span><span class="p">(</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">mip_era</span><span class="p">,</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">activity_id</span><span class="p">,</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">institution_id</span><span class="p">,</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">,</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">member_id</span><span class="p">,</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="p">,</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">variable_id</span><span class="p">,</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">grid_label</span><span class="p">,</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">PurePath</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">/</span> <span class="n">d</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>

<div class="viewcode-block" id="DRS.splitFileName"><a class="viewcode-back" href="../../cmiputil.html#cmiputil.drs.DRS.splitFileName">[docs]</a>    <span class="k">def</span> <span class="nf">splitFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split filename to attributes for DRS.</span>

<span class="sd">        Set them as members of the instance and also return as a dict.</span>

<span class="sd">        Args:</span>
<span class="sd">            fname (Path-like): filename</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if `fname` is invalid for DRS.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: attribute and it&#39;s value</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; fname = &quot;tas_Amon_MIROC6_piControl_r1i1p1f1_gn_320001-329912.nc&quot;</span>
<span class="sd">            &gt;&gt;&gt; drs.DRS().splitFileName(fname) # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">            {&#39;experiment_id&#39;: &#39;piControl&#39;, &#39;grid_label&#39;: &#39;gn&#39;,</span>
<span class="sd">            &#39;source_id&#39;: &#39;MIROC6&#39;, &#39;table_id&#39;: &#39;Amon&#39;, &#39;time_range&#39;:</span>
<span class="sd">            &#39;320001-329912&#39;, &#39;variable_id&#39;: &#39;tas&#39;, &#39;variant_label&#39;:</span>
<span class="sd">            &#39;r1i1p1f1&#39;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">variable_id</span><span class="p">,</span>
         <span class="n">table_id</span><span class="p">,</span>
         <span class="n">source_id</span><span class="p">,</span>
         <span class="n">experiment_id</span><span class="p">,</span>
         <span class="n">member_id</span><span class="p">,</span>
         <span class="n">grid_label</span><span class="p">)</span> <span class="o">=</span> <span class="n">PurePath</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">grid_label</span><span class="p">,</span> <span class="n">time_range</span><span class="p">)</span> <span class="o">=</span> <span class="n">grid_label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># time_range = None</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">sub_experiment_id</span><span class="p">,</span> <span class="n">variant_label</span><span class="p">)</span> <span class="o">=</span> <span class="n">member_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">variant_label</span> <span class="o">=</span> <span class="n">member_id</span>
            <span class="c1"># sub_experiment_id = None</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">DRS</span><span class="o">.</span><span class="n">requiredAttribs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">res</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="DRS.splitDirName"><a class="viewcode-back" href="../../cmiputil.html#cmiputil.drs.DRS.splitDirName">[docs]</a>    <span class="k">def</span> <span class="nf">splitDirName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split dirname to attributes for DRS.</span>

<span class="sd">        Then set them as members of the instance, and also return as a dict.</span>

<span class="sd">        Args:</span>
<span class="sd">            dname (path-like) : directory name</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: attribute and it&#39;s value, {} if `dname` is not enough.</span>

<span class="sd">        Examples:</span>

<span class="sd">            &gt;&gt;&gt; dname = (&#39;/work/data/CMIP6/CMIP6/CMIP/MIROC/MIROC6/&#39;</span>
<span class="sd">            ...          &#39;piControl/r1i1p1f1/Amon/tas/gn/v20190308&#39;)</span>
<span class="sd">            &gt;&gt;&gt; drs.DRS().splitDirName(dname) # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">            {&#39;activity_id&#39;: &#39;CMIP&#39;, &#39;experiment_id&#39;: &#39;piControl&#39;,</span>
<span class="sd">            &#39;grid_label&#39;: &#39;gn&#39;, &#39;institution_id&#39;: &#39;MIROC&#39;, &#39;mip_era&#39;: &#39;CMIP6&#39;,</span>
<span class="sd">            &#39;source_id&#39;: &#39;MIROC6&#39;, &#39;table_id&#39;: &#39;Amon&#39;, &#39;variable_id&#39;: &#39;tas&#39;,</span>
<span class="sd">            &#39;variant_label&#39;: &#39;r1i1p1f1&#39;, &#39;version&#39;: &#39;v20190308&#39;,</span>
<span class="sd">            &#39;prefix&#39;: &#39;/work/data/CMIP6&#39;}</span>

<span class="sd">            &gt;&gt;&gt; dname = (&#39;CMIP6/CMIP/MIROC/MIROC6/piControl/r1i1p1f1/&#39;</span>
<span class="sd">            ...          &#39;Amon/tas/gn/v20190308&#39;)</span>
<span class="sd">            &gt;&gt;&gt; drs.DRS().splitDirName(dname) # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">            {&#39;activity_id&#39;: &#39;CMIP&#39;, &#39;experiment_id&#39;: &#39;piControl&#39;,</span>
<span class="sd">            &#39;grid_label&#39;: &#39;gn&#39;, &#39;institution_id&#39;: &#39;MIROC&#39;, &#39;mip_era&#39;: &#39;CMIP6&#39;,</span>
<span class="sd">            &#39;source_id&#39;: &#39;MIROC6&#39;, &#39;table_id&#39;: &#39;Amon&#39;, &#39;variable_id&#39;: &#39;tas&#39;,</span>
<span class="sd">            &#39;variant_label&#39;: &#39;r1i1p1f1&#39;, &#39;version&#39;: &#39;v20190308&#39;, &#39;prefix&#39;: &#39;&#39;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">PurePath</span><span class="p">(</span><span class="n">dname</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">version</span><span class="p">,</span>
             <span class="n">grid_label</span><span class="p">,</span>
             <span class="n">variable_id</span><span class="p">,</span>
             <span class="n">table_id</span><span class="p">,</span>
             <span class="n">member_id</span><span class="p">,</span>
             <span class="n">experiment_id</span><span class="p">,</span>
             <span class="n">source_id</span><span class="p">,</span>
             <span class="n">institution_id</span><span class="p">,</span>
             <span class="n">activity_id</span><span class="p">,</span>
             <span class="n">mip_era</span><span class="p">)</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">11</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">sub_experiment_id</span><span class="p">,</span> <span class="n">variant_label</span><span class="p">)</span> <span class="o">=</span> <span class="n">member_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">variant_label</span> <span class="o">=</span> <span class="n">member_id</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">DRS</span><span class="o">.</span><span class="n">requiredAttribs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">res</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">PurePath</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="o">.</span><span class="n">parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">10</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="DRS.isValidPath"><a class="viewcode-back" href="../../cmiputil.html#cmiputil.drs.DRS.isValidPath">[docs]</a>    <span class="k">def</span> <span class="nf">isValidPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">separated</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if given `path` is DRS compliant.</span>

<span class="sd">        `path` may be a URL obtained by ESGF Search function. See</span>
<span class="sd">        :mod:`cmiputil.esgfsearch` for details.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (Path-like) : pathname to be checked</span>
<span class="sd">            directory (bool) : treat `path` is a directory</span>
<span class="sd">            separated (bool) : return a tuple of two dicts</span>

<span class="sd">        If `separate` is True, return a tuple of two dicts, first</span>
<span class="sd">        element is for the filename, second is for the directory name,</span>
<span class="sd">        both dicts&#39; key/value shows that each attributes are valid or</span>
<span class="sd">        not. If `directory` is ``True``, first elements is just a ``True``.</span>

<span class="sd">        Examples:</span>

<span class="sd">            &gt;&gt;&gt; url = (&#39;http://vesg.ipsl.upmc.fr/thredds/fileServer/cmip6/DCPP/IPSL/&#39;</span>
<span class="sd">            ...       &#39;IPSL-CM6A-LR/dcppC-pac-pacemaker/s1920-r1i1p1f1/Amon/rsdscs/&#39;</span>
<span class="sd">            ...       &#39;gr/v20190110/rsdscs_Amon_IPSL-CM6A-LR_dcppC-pac-&#39;</span>
<span class="sd">            ...       &#39;pacemaker_s1920-r1i1p1f1_gr_192001-201412.nc&#39;)</span>
<span class="sd">            &gt;&gt;&gt; drs.DRS().isValidPath(url)</span>
<span class="sd">            True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">PurePath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">dname</span> <span class="o">=</span> <span class="n">p</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span>
            <span class="n">dname</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">fname</span><span class="p">):</span>
            <span class="n">f_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitFileName</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">f_res</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">isValidValueForAttr</span><span class="p">(</span><span class="n">f_attr</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">a</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">f_attr</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">DRS</span><span class="o">.</span><span class="n">requiredAttribs</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f_res</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dname</span> <span class="o">!=</span> <span class="n">PurePath</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)):</span>
            <span class="n">d_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitDirName</span><span class="p">(</span><span class="n">dname</span><span class="p">)</span>
            <span class="n">d_res</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">isValidValueForAttr</span><span class="p">(</span><span class="n">d_attr</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">a</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">d_attr</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">DRS</span><span class="o">.</span><span class="n">requiredAttribs</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d_res</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">separated</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f_res</span><span class="p">,</span> <span class="n">d_res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">((</span><span class="n">f_res</span><span class="p">,</span> <span class="n">d_res</span><span class="p">))</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cmiputil</span> <span class="k">import</span> <span class="n">drs</span>
    <span class="kn">import</span> <span class="nn">doctest</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">cmiputil  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, RIST.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>